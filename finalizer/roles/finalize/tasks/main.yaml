---

- name: "[FINALIZE] - Create Bundle Directory"
  become: true
  file:
    state: directory
    owner: 1000
    group: 1000
    mode: 0750
    path: "{{ bundle_path }}"
  
- name: "[FINALIZE] - Check that the output.yaml exists"
  stat:
    path: "{{ bundle_path }}/output.yaml"
  register: stat_result

- block:
  - name: "[FINALIZE] - Include Test Output Variables"
    include_vars: "{{ bundle_path }}/output.yaml"
  - name: "[FINALIZE] - Create Pac Output as Markdown"
    template:
      src: templates/output.md.j2
      dest: "{{ bundle_path }}/output.md"
      mode: u+rw,g-wx,o-rwx
  when: stat_result.stat.exists

- name: "[FINALIZE] - Compress Bundle"
  block:
  - name: "[FINALIZE] - Run Subtasks for Instance Output Files"
    include: instance-subtasks.yml filename="{{ vars['ins']['type'] }}"
    when: 
    - vars['ins']['enabled'] == true

  - name: "[FINALIZE] - Run Subtasks for Engine Output Files"
    include: engine-subtasks.yml filename="{{ vars['engine']['type'] }}"
    when: 
    - vars['engine']['enabled'] == true
  
  - name: "[FINALIZE] - Tar Bundle"
    #changed_when: false
    shell: "tar czf /tmp/bundle.tar.gz {{ bundle_path }} {{ vars_path }} {{ manifests_path }} {{ sensitive_path }} ; mv /tmp/bundle.tar.gz {{ bundle_path }}/bundle.tar.gz"
  when: COMPRESS_BUNDLE | bool == true
