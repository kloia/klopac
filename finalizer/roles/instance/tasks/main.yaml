---

# TODO: stop creating multiple instance_layer keys in output.yaml
# TODO: should yq tasks be with a loop or not?

- name: Create bundle directory
  delegate_to: localhost
  file:
    state: directory
    owner: 1000
    group: 1000
    mode: 0750
    path: "/data/bundle"

- name: "Create inventory file"
  changed_when: false
  delegate_to: localhost
  shell: echo "instance_layer:" >> /data/bundle/output.yaml

- name: Get OS Information
  set_fact:
    OS_NAME: '{{ img.os.split(":")[0] | lower }}'
    OS_VERSION: '{{ img.os.split(":")[1] | lower }}'

- name: Get OS Name
  changed_when: false
  shell: |
    set -o pipefail
    cat /etc/*release* | grep -E "^NAME" | awk -F"=" '{ print $2 }' | sed 's/"//g'
  args:
    executable: /bin/bash
  register: os_name

- name: Get OS Version
  changed_when: false
  shell: |
    set -o pipefail
    cat /etc/*release* | grep -E "^VERSION=" | awk -F"=" '{ print $2 }' | sed 's/"//g' | awk '{ print $1}'
  args:
    executable: /bin/bash
  register: os_version

- name: Write os_name checks to outputs
  delegate_to: localhost
  changed_when: false
  shell: "yq -i '.instance_layer.os.name.value = \"{{ os_name.stdout | lower }}\"' /data/bundle/output.yaml -y"

- name: Write os_name checks to outputs
  delegate_to: localhost
  changed_when: false
  shell: "yq -i '.instance_layer.os.name.match = \"{{ os_name.stdout | lower == OS_NAME }}\"' /data/bundle/output.yaml -y"

- name: Write os_version checks to outputs
  delegate_to: localhost
  changed_when: false
  shell: "yq -i '.instance_layer.os.version.value = \"{{ os_version.stdout | lower }}\"' /data/bundle/output.yaml -y"

- name: Write os_name checks to outputs
  delegate_to: localhost
  changed_when: false
  shell: "yq -i '.instance_layer.os.version.match = \"{{ os_version.stdout | lower == OS_NAME }}\"' /data/bundle/output.yaml -y"
